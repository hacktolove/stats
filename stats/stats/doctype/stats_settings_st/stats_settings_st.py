# Copyright (c) 2024, GreyCube Technologies and contributors
# For license information, please see license.txt

import frappe
from frappe.model.document import Document
from frappe import _


class StatsSettingsST(Document):
	def validate(self):
		self.validate_default_new_hire_earning_component()
		# if not self.erpnext_auth_url:
		portal_to_call_api_method="/api/method/stats.auth.call_stats_erpnext"
		self.erpnext_auth_url = frappe.utils.get_url()+portal_to_call_api_method

	def validate_default_new_hire_earning_component(self):
		if self.default_new_hire_earning_component:
			employee_grade_list = frappe.db.get_list("Employee Grade",fields=["name", "custom_basic_salary_component"])

			unique_basic_salary_component = []
			if len(employee_grade_list) > 0:
				for grade in employee_grade_list:
					if grade.custom_basic_salary_component:
						unique_basic_salary_component.append(grade.custom_basic_salary_component)

			if len(unique_basic_salary_component) > 0:
				if self.default_new_hire_earning_component in unique_basic_salary_component:
					frappe.throw(_("Default New Hire Earning Component should not be Basic Salary Component"))

	@frappe.whitelist()
	def delete_attendance_and_employee_checkins(self):
		print("---")
		attendance_list = frappe.db.get_all("Attendance", filters={"status":["In",["Absent","Half Day","Present"]]}, fields=["name"])
		if len(attendance_list)>0:
			for attendance in attendance_list:
				att_doc = frappe.get_doc("Attendance", attendance.name)
				print("delete_attendance_and_employee_checkins", att_doc.name)
				att_doc.cancel()
				att_doc.delete()
				frappe.db.commit()
		
		frappe.db.delete("Employee Checkin")
		print("Employee Checkins deleted successfully")
		frappe.db.commit()
		frappe.msgprint(_("Attendance and Employee Checkins are deleted successfully."))


	@frappe.whitelist()
	def fix_checkin_for_old(self):
		shift_list = frappe.db.get_list('Shift Type', fields=['name', 'start_time'])
		count = 0
		for shift in shift_list:
			checkin_list = frappe.db.get_all('Employee Checkin', filters={'shift': shift.name, 'shift_actual_end': None}, fields=['name'])
			for checkin in checkin_list:
				checkin_doc = frappe.get_doc('Employee Checkin', checkin.name)
				checkin_doc.fetch_shift()
				checkin_doc.flags.ignore_validate = True
				checkin_doc.save()
				frappe.db.commit()
				count += 1
				frappe.publish_progress(count / len(checkin_list) * 100, title=_("Updating Employee Checkins..."))
		frappe.msgprint(_("Checkin for old shifts fixed successfully."))

	@frappe.whitelist()
	def delete_off_shift_employee_checkin_for_two_shift_types(self):
		delete_employee_checkin_of_one_shift = frappe.db.sql(
			"""
				DELETE
				FROM
					`tabEmployee Checkin`
				WHERE
					name IN ('EMP-CKIN-06-2025-010847', 'EMP-CKIN-06-2025-005501', 'EMP-CKIN-06-2025-005496', 'EMP-CKIN-06-2025-005500', 'EMP-CKIN-06-2025-008225', 'EMP-CKIN-06-2025-002739', 'EMP-CKIN-06-2025-002745', 'EMP-CKIN-06-2025-002748', 'EMP-CKIN-06-2025-002752', 'EMP-CKIN-06-2025-002755', 'EMP-CKIN-06-2025-002757', 'EMP-CKIN-06-2025-002769', 'EMP-CKIN-06-2025-002771', 'EMP-CKIN-06-2025-002773', 'EMP-CKIN-06-2025-012142', 'EMP-CKIN-06-2025-012143', 'EMP-CKIN-06-2025-012145', 'EMP-CKIN-06-2025-012148', 'EMP-CKIN-06-2025-012149', 'EMP-CKIN-06-2025-012151', 'EMP-CKIN-06-2025-012152', 'EMP-CKIN-06-2025-012154', 'EMP-CKIN-06-2025-012155', 'EMP-CKIN-06-2025-012156', 'EMP-CKIN-06-2025-012158', 'EMP-CKIN-06-2025-012159', 'EMP-CKIN-06-2025-012160', 'EMP-CKIN-06-2025-012162', 'EMP-CKIN-06-2025-012165', 'EMP-CKIN-06-2025-012167', 'EMP-CKIN-06-2025-012168', 'EMP-CKIN-06-2025-012169', 'EMP-CKIN-06-2025-012172', 'EMP-CKIN-06-2025-012173', 'EMP-CKIN-06-2025-002764', 'EMP-CKIN-06-2025-005524', 'EMP-CKIN-06-2025-008244', 'EMP-CKIN-06-2025-010843', 'EMP-CKIN-06-2025-011998', 'EMP-CKIN-06-2025-015448', 'EMP-CKIN-06-2025-012047', 'EMP-CKIN-06-2025-012048', 'EMP-CKIN-06-2025-012049', 'EMP-CKIN-06-2025-015442', 'EMP-CKIN-06-2025-012008', 'EMP-CKIN-06-2025-002740', 'EMP-CKIN-06-2025-005504', 'EMP-CKIN-06-2025-015415', 'EMP-CKIN-06-2025-018851', 'EMP-CKIN-06-2025-022217', 'EMP-CKIN-06-2025-011490', 'EMP-CKIN-06-2025-011491', 'EMP-CKIN-06-2025-011494', 'EMP-CKIN-06-2025-011499', 'EMP-CKIN-06-2025-011500', 'EMP-CKIN-06-2025-011501', 'EMP-CKIN-06-2025-011502', 'EMP-CKIN-06-2025-011503', 'EMP-CKIN-06-2025-005513', 'EMP-CKIN-06-2025-015389', 'EMP-CKIN-06-2025-022192', 'EMP-CKIN-06-2025-005506', 'EMP-CKIN-06-2025-002780', 'EMP-CKIN-06-2025-005542', 'EMP-CKIN-06-2025-008268', 'EMP-CKIN-06-2025-010852', 'EMP-CKIN-06-2025-015508', 'EMP-CKIN-06-2025-018898', 'EMP-CKIN-06-2025-022267', 'EMP-CKIN-06-2025-008255', 'EMP-CKIN-06-2025-011855', 'EMP-CKIN-06-2025-002763', 'EMP-CKIN-06-2025-005522', 'EMP-CKIN-06-2025-008245', 'EMP-CKIN-06-2025-010842', 'EMP-CKIN-06-2025-012004', 'EMP-CKIN-06-2025-002754', 'EMP-CKIN-06-2025-005514', 'EMP-CKIN-06-2025-008232', 'EMP-CKIN-06-2025-010820', 'EMP-CKIN-06-2025-011662', 'EMP-CKIN-06-2025-015413', 'EMP-CKIN-06-2025-018819', 'EMP-CKIN-06-2025-022212', 'EMP-CKIN-06-2025-022214', 'EMP-CKIN-06-2025-015549', 'EMP-CKIN-06-2025-018829', 'EMP-CKIN-06-2025-002778', 'EMP-CKIN-06-2025-005537', 'EMP-CKIN-06-2025-008266', 'EMP-CKIN-06-2025-012002', 'EMP-CKIN-06-2025-018869', 'EMP-CKIN-06-2025-011646', 'EMP-CKIN-06-2025-011648', 'EMP-CKIN-06-2025-011653', 'EMP-CKIN-06-2025-011658', 'EMP-CKIN-06-2025-011848', 'EMP-CKIN-06-2025-011849', 'EMP-CKIN-06-2025-015456', 'EMP-CKIN-06-2025-018821', 'EMP-CKIN-06-2025-022213', 'EMP-CKIN-06-2025-002782', 'EMP-CKIN-06-2025-005550', 'EMP-CKIN-06-2025-008267', 'EMP-CKIN-06-2025-012003', 'EMP-CKIN-06-2025-015452', 'EMP-CKIN-06-2025-018848', 'EMP-CKIN-06-2025-008222', 'EMP-CKIN-06-2025-008304', 'EMP-CKIN-06-2025-015400', 'EMP-CKIN-06-2025-015554', 'EMP-CKIN-06-2025-018919', 'EMP-CKIN-06-2025-022286', 'EMP-CKIN-06-2025-012213', 'EMP-CKIN-06-2025-002770', 'EMP-CKIN-06-2025-005549', 'EMP-CKIN-06-2025-008254', 'EMP-CKIN-06-2025-010837', 'EMP-CKIN-06-2025-012006', 'EMP-CKIN-06-2025-012171', 'EMP-CKIN-06-2025-015446', 'EMP-CKIN-06-2025-002756', 'EMP-CKIN-06-2025-011995', 'EMP-CKIN-06-2025-015441', 'EMP-CKIN-06-2025-018835', 'EMP-CKIN-06-2025-022227', 'EMP-CKIN-06-2025-015429', 'EMP-CKIN-06-2025-015430', 'EMP-CKIN-06-2025-015460', 'EMP-CKIN-06-2025-015461', 'EMP-CKIN-06-2025-022271', 'EMP-CKIN-06-2025-015459', 'EMP-CKIN-06-2025-018852', 'EMP-CKIN-06-2025-022236', 'EMP-CKIN-06-2025-002775', 'EMP-CKIN-06-2025-005535', 'EMP-CKIN-06-2025-008252', 'EMP-CKIN-06-2025-010828', 'EMP-CKIN-06-2025-015451', 'EMP-CKIN-06-2025-018849', 'EMP-CKIN-06-2025-022237', 'EMP-CKIN-06-2025-012204', 'EMP-CKIN-06-2025-022305', 'EMP-CKIN-06-2025-002742', 'EMP-CKIN-06-2025-010821', 'EMP-CKIN-06-2025-011993', 'EMP-CKIN-06-2025-011994', 'EMP-CKIN-06-2025-002759', 'EMP-CKIN-06-2025-010885', 'EMP-CKIN-06-2025-011996', 'EMP-CKIN-06-2025-015447', 'EMP-CKIN-06-2025-002777', 'EMP-CKIN-06-2025-005533', 'EMP-CKIN-06-2025-022229', 'EMP-CKIN-06-2025-002736', 'EMP-CKIN-06-2025-005495', 'EMP-CKIN-06-2025-008216', 'EMP-CKIN-06-2025-010809', 'EMP-CKIN-06-2025-012005', 'EMP-CKIN-06-2025-015449', 'EMP-CKIN-06-2025-018838', 'EMP-CKIN-06-2025-022225', 'EMP-CKIN-06-2025-002753', 'EMP-CKIN-06-2025-002779', 'EMP-CKIN-06-2025-012007', 'EMP-CKIN-06-2025-015425', 'EMP-CKIN-06-2025-002792', 'EMP-CKIN-06-2025-005538', 'EMP-CKIN-06-2025-008264', 'EMP-CKIN-06-2025-012001', 'EMP-CKIN-06-2025-015469', 'EMP-CKIN-06-2025-018865', 'EMP-CKIN-06-2025-022254', 'EMP-CKIN-06-2025-002774', 'EMP-CKIN-06-2025-005536', 'EMP-CKIN-06-2025-008261', 'EMP-CKIN-06-2025-010844', 'EMP-CKIN-06-2025-012000', 'EMP-CKIN-06-2025-018855', 'EMP-CKIN-06-2025-022235', 'EMP-CKIN-06-2025-002738', 'EMP-CKIN-06-2025-002743', 'EMP-CKIN-06-2025-002746', 'EMP-CKIN-06-2025-002751', 'EMP-CKIN-06-2025-002772', 'EMP-CKIN-06-2025-015403', 'EMP-CKIN-06-2025-015406', 'EMP-CKIN-06-2025-015436', 'EMP-CKIN-06-2025-018815', 'EMP-CKIN-06-2025-018816', 'EMP-CKIN-06-2025-018817', 'EMP-CKIN-06-2025-018827', 'EMP-CKIN-06-2025-018836', 'EMP-CKIN-06-2025-022195', 'EMP-CKIN-06-2025-022210', 'EMP-CKIN-06-2025-022215', 'EMP-CKIN-06-2025-022233', 'EMP-CKIN-06-2025-011644', 'EMP-CKIN-06-2025-011645', 'EMP-CKIN-06-2025-011647', 'EMP-CKIN-06-2025-011649', 'EMP-CKIN-06-2025-011654', 'EMP-CKIN-06-2025-011655', 'EMP-CKIN-06-2025-011656', 'EMP-CKIN-06-2025-011657', 'EMP-CKIN-06-2025-011488', 'EMP-CKIN-06-2025-011489', 'EMP-CKIN-06-2025-011492', 'EMP-CKIN-06-2025-011493', 'EMP-CKIN-06-2025-011495', 'EMP-CKIN-06-2025-011496', 'EMP-CKIN-06-2025-011497', 'EMP-CKIN-06-2025-011498', 'EMP-CKIN-06-2025-012144', 'EMP-CKIN-06-2025-012150', 'EMP-CKIN-06-2025-012153', 'EMP-CKIN-06-2025-012157', 'EMP-CKIN-06-2025-002781', 'EMP-CKIN-06-2025-005543', 'EMP-CKIN-06-2025-008265', 'EMP-CKIN-06-2025-011999', 'EMP-CKIN-06-2025-015453', 'EMP-CKIN-06-2025-018839', 'EMP-CKIN-06-2025-022228', 'EMP-CKIN-06-2025-010881', 'EMP-CKIN-06-2025-012046', 'EMP-CKIN-06-2025-002762', 'EMP-CKIN-06-2025-005526', 'EMP-CKIN-06-2025-008247', 'EMP-CKIN-06-2025-008248', 'EMP-CKIN-06-2025-011997', 'EMP-CKIN-06-2025-015450', 'EMP-CKIN-06-2025-018843', 'EMP-CKIN-06-2025-022232', 'EMP-CKIN-06-2025-015454', 'EMP-CKIN-06-2025-018840', 'EMP-CKIN-06-2025-022230')
							"""
		)

		delete_employee_checkin_of_second_shift = frappe.db.sql(
		"""
			DELETE																									
			FROM																									
			`tabEmployee Checkin`																									
			WHERE																									
			name IN ('EMP-CKIN-06-2025-012118', 'EMP-CKIN-06-2025-012119', 'EMP-CKIN-06-2025-012121', 'EMP-CKIN-06-2025-012124', 'EMP-CKIN-06-2025-012126', 'EMP-CKIN-06-2025-012128', 'EMP-CKIN-06-2025-012129', 'EMP-CKIN-06-2025-012134', 'EMP-CKIN-06-2025-012137', 'EMP-CKIN-06-2025-012140', 'EMP-CKIN-06-2025-012141', 'EMP-CKIN-06-2025-012146', 'EMP-CKIN-06-2025-012147', 'EMP-CKIN-06-2025-012161', 'EMP-CKIN-06-2025-012163', 'EMP-CKIN-06-2025-012164', 'EMP-CKIN-06-2025-012166', 'EMP-CKIN-06-2025-012170', 'EMP-CKIN-06-2025-012174', 'EMP-CKIN-06-2025-012177', 'EMP-CKIN-06-2025-015439', 'EMP-CKIN-06-2025-015444', 'EMP-CKIN-06-2025-015555', 'EMP-CKIN-06-2025-018929', 'EMP-CKIN-06-2025-022117', 'EMP-CKIN-06-2025-022295', 'EMP-CKIN-06-2025-012051', 'EMP-CKIN-06-2025-012052', 'EMP-CKIN-06-2025-015431', 'EMP-CKIN-06-2025-015529', 'EMP-CKIN-06-2025-018908', 'EMP-CKIN-06-2025-022273', 'EMP-CKIN-06-2025-015377', 'EMP-CKIN-06-2025-015386', 'EMP-CKIN-06-2025-015390', 'EMP-CKIN-06-2025-015393', 'EMP-CKIN-06-2025-015394', 'EMP-CKIN-06-2025-015396', 'EMP-CKIN-06-2025-015405', 'EMP-CKIN-06-2025-015407', 'EMP-CKIN-06-2025-015412', 'EMP-CKIN-06-2025-015414', 'EMP-CKIN-06-2025-015424', 'EMP-CKIN-06-2025-015428', 'EMP-CKIN-06-2025-015434', 'EMP-CKIN-06-2025-015457', 'EMP-CKIN-06-2025-015463', 'EMP-CKIN-06-2025-015464', 'EMP-CKIN-06-2025-015455', 'EMP-CKIN-06-2025-018841', 'EMP-CKIN-06-2025-022231', 'EMP-CKIN-06-2025-015358', 'EMP-CKIN-06-2025-018764', 'EMP-CKIN-06-2025-015539', 'EMP-CKIN-06-2025-012199', 'EMP-CKIN-06-2025-015547', 'EMP-CKIN-06-2025-018921', 'EMP-CKIN-06-2025-022292', 'EMP-CKIN-06-2025-015470', 'EMP-CKIN-06-2025-018853', 'EMP-CKIN-06-2025-018854', 'EMP-CKIN-06-2025-018870', 'EMP-CKIN-06-2025-022248', 'EMP-CKIN-06-2025-022257', 'EMP-CKIN-06-2025-012202', 'EMP-CKIN-06-2025-012178', 'EMP-CKIN-06-2025-015440', 'EMP-CKIN-06-2025-015443', 'EMP-CKIN-06-2025-018928', 'EMP-CKIN-06-2025-022300', 'EMP-CKIN-06-2025-015471', 'EMP-CKIN-06-2025-018844', 'EMP-CKIN-06-2025-018876', 'EMP-CKIN-06-2025-022249', 'EMP-CKIN-06-2025-022256', 'EMP-CKIN-06-2025-012203', 'EMP-CKIN-06-2025-015544', 'EMP-CKIN-06-2025-018918', 'EMP-CKIN-06-2025-022281', 'EMP-CKIN-06-2025-015361', 'EMP-CKIN-06-2025-015363', 'EMP-CKIN-06-2025-015385', 'EMP-CKIN-06-2025-015392', 'EMP-CKIN-06-2025-015416', 'EMP-CKIN-06-2025-015422', 'EMP-CKIN-06-2025-015437', 'EMP-CKIN-06-2025-015438', 'EMP-CKIN-06-2025-018602', 'EMP-CKIN-06-2025-022019')	
		"""
		)

		frappe.db.commit()
		frappe.msgprint(_("Employee Checkins are Deleted for <b>المناوبة الصباحية</b> and <b>المناوبة الصباحية - الرسميين</b>"))
	
	@frappe.whitelist()
	def delete_custom_fields_of_custom_doctypes(self):
		delete_all_custo_fields = frappe.db.sql("""
			DELETE FROM
				`tabCustom Field`
			WHERE label != 'Workflow State' and
				dt in (
				SELECT
					name
				FROM
					`tabDocType` as d
				WHERE
					d.module = 'Stats')
			""")
		frappe.db.commit()
		frappe.msgprint(_("Custom Fields are deleted for all custom doctypes in Stats module."))